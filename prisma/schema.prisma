// Prisma Schema for BeautyBook
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Model (synced with Clerk)
model User {
  id            String   @id @default(cuid())
  clerkId       String   @unique
  email         String   @unique
  firstName     String?
  lastName      String?
  imageUrl      String?
  role          UserRole @default(CUSTOMER)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  customerProfile CustomerProfile?
  providerProfile ProviderProfile?
  appointments    Appointment[]
  reviews         Review[]
  favorites       Favorite[]
  notifications   Notification[]
  notificationPreference NotificationPreference?
  staffMember     StaffMember?
  campaigns       Campaign[]
  couponUsages    CouponUsage[]
  referralsGiven  Referral[]      @relation("Referrer")
  referralsReceived Referral[]    @relation("Referee")
  wallet          CustomerWallet?

  @@map("users")
}

enum UserRole {
  CUSTOMER
  PROVIDER
  ADMIN
}

// Customer Profile
model CustomerProfile {
  id            String   @id @default(cuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  phone         String?
  dateOfBirth   DateTime?
  address       String?
  city          String?
  state         String?
  zipCode       String?

  // Medical History
  medicalHistory Json?
  allergies      String[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("customer_profiles")
}

// Provider Profile
model ProviderProfile {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Basic Info
  businessName    String
  title           String
  bio             String   @db.Text
  phone           String
  verified        Boolean  @default(false)

  // Location
  address         String
  city            String
  state           String
  zipCode         String
  latitude        Float?
  longitude       Float?

  // Professional Info
  experience      Int      @default(0) // years
  languages       String[]
  specialties     String[]

  // Pricing
  priceMin        Float
  priceMax        Float

  // Insurance
  insuranceAccepted String[]

  // Ratings
  averageRating   Float    @default(0)
  reviewCount     Int      @default(0)

  // Business Hours
  businessHours   Json?

  // Public Booking & QR Code
  bookingSlug         String?  @unique
  qrCodeEnabled       Boolean  @default(true)
  publicBookingEnabled Boolean @default(true)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  education       Education[]
  certifications  Certification[]
  services        Service[]
  appointments    Appointment[]
  reviews         Review[]
  availability    Availability[]
  portfolios      Portfolio[]
  beforeAfterPhotos BeforeAfterPhoto[]
  cancellationRules CancellationRule[]
  staffMembers    StaffMember[]
  products        Product[]
  campaigns       Campaign[]
  coupons         Coupon[]
  referralProgram ReferralProgram?
  referrals       Referral[]

  @@map("provider_profiles")
}

// Education
model Education {
  id           String          @id @default(cuid())
  providerId   String
  provider     ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)
  degree       String
  institution  String
  year         Int
  createdAt    DateTime        @default(now())

  @@map("education")
}

// Certification
model Certification {
  id           String          @id @default(cuid())
  providerId   String
  provider     ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)
  name         String
  issuer       String
  year         Int
  expiryDate   DateTime?
  createdAt    DateTime        @default(now())

  @@map("certifications")
}

// Service
model Service {
  id          String          @id @default(cuid())
  providerId  String
  provider    ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)
  name        String
  description String          @db.Text
  duration    Int             // minutes
  price       Float
  category    String
  active      Boolean         @default(true)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  // Relations
  appointments Appointment[]

  @@map("services")
}

// Appointment
model Appointment {
  id          String            @id @default(cuid())

  // Relations
  customerId  String
  customer    User              @relation(fields: [customerId], references: [id])
  providerId  String
  provider    ProviderProfile   @relation(fields: [providerId], references: [id])
  serviceId   String
  service     Service           @relation(fields: [serviceId], references: [id])

  // Appointment Details
  date        DateTime
  startTime   String
  endTime     String
  status      AppointmentStatus @default(SCHEDULED)
  notes       String?           @db.Text

  // Payment
  amount      Float
  paymentStatus PaymentStatus   @default(PENDING)
  paymentId   String?

  // Cancellation Policy & Deposit
  cancellationPolicy  CancellationPolicy @default(STANDARD)
  depositRequired     Boolean            @default(false)
  depositAmount       Float?
  depositPaid         Boolean            @default(false)
  depositPaymentId    String?

  // Cancellation Details
  cancelledAt         DateTime?
  cancelledBy         String? // userId
  cancellationReason  String?
  cancellationFee     Float?
  cancellationFeePaid Boolean            @default(false)

  // Calendar Integration
  googleEventId String?

  // Staff Assignment
  staffMemberId String?
  staffMember   StaffMember? @relation(fields: [staffMemberId], references: [id])

  // Timestamps
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  // Relations
  notifications Notification[]

  @@map("appointments")
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum PaymentStatus {
  PENDING
  PAID
  REFUNDED
  FAILED
}

// Review
model Review {
  id          String          @id @default(cuid())
  customerId  String
  customer    User            @relation(fields: [customerId], references: [id])
  providerId  String
  provider    ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)

  rating      Int             // 1-5
  comment     String          @db.Text
  verified    Boolean         @default(false)
  helpful     Int             @default(0)

  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@map("reviews")
}

// Favorite (Save providers)
model Favorite {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  providerId  String
  createdAt   DateTime @default(now())

  @@unique([userId, providerId])
  @@map("favorites")
}

// Availability (Provider's available time slots)
model Availability {
  id          String          @id @default(cuid())
  providerId  String
  provider    ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)

  dayOfWeek   Int             // 0-6 (Sunday-Saturday)
  startTime   String
  endTime     String
  active      Boolean         @default(true)

  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@map("availability")
}

// ==================== Phase 1: Notification System ====================

// Notification Preferences
model NotificationPreference {
  id           String   @id @default(cuid())
  userId       String   @unique
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Channel Settings
  emailEnabled Boolean  @default(true)
  smsEnabled   Boolean  @default(true)
  pushEnabled  Boolean  @default(true)

  // Reminder Timing
  reminderBefore24h Boolean @default(true)
  reminderBefore2h  Boolean @default(true)
  reminderBefore30m Boolean @default(false)

  // Marketing
  marketingEnabled  Boolean @default(false)
  birthdayReminders Boolean @default(true)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("notification_preferences")
}

// Notification
model Notification {
  id            String             @id @default(cuid())
  userId        String
  user          User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  appointmentId String?
  appointment   Appointment?       @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  type          NotificationType
  channel       NotificationChannel
  status        NotificationStatus @default(PENDING)

  // Content
  subject       String?
  message       String            @db.Text
  data          Json?             // Additional data

  // Scheduling
  scheduledFor  DateTime
  sentAt        DateTime?

  // Delivery tracking
  deliveryId    String?           // Twilio/SendGrid ID
  error         String?

  createdAt     DateTime          @default(now())

  @@index([userId, status])
  @@index([scheduledFor])
  @@map("notifications")
}

enum NotificationType {
  APPOINTMENT_REMINDER
  APPOINTMENT_CONFIRMED
  APPOINTMENT_CANCELLED
  APPOINTMENT_RESCHEDULED
  REVIEW_REQUEST
  PROMOTION
  BIRTHDAY
  PAYMENT_RECEIVED
  DEPOSIT_REQUIRED
}

enum NotificationChannel {
  EMAIL
  SMS
  PUSH
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
  CANCELLED
}

// ==================== Phase 1: Cancellation Policy ====================

enum CancellationPolicy {
  FLEXIBLE   // Cancel anytime
  MODERATE   // Cancel 12h before
  STANDARD   // Cancel 24h before
  STRICT     // Cancel 48h before
}

// Cancellation Rules
model CancellationRule {
  id              String          @id @default(cuid())
  providerId      String
  provider        ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)

  policy          CancellationPolicy @default(STANDARD)
  hoursBeforeAppt Int             // Hours before appointment
  feePercentage   Float           // 0-100
  feeFixed        Float?          // Optional fixed fee

  applyToNewClients Boolean       @default(true)
  active          Boolean         @default(true)

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@map("cancellation_rules")
}

// ==================== Phase 1: Portfolio & Photos ====================

// Portfolio
model Portfolio {
  id          String          @id @default(cuid())
  providerId  String
  provider    ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)

  title       String
  description String?         @db.Text
  category    String          // "Hair", "Makeup", "Nails", etc.
  featured    Boolean         @default(false)
  viewCount   Int             @default(0)

  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  images      PortfolioImage[]

  @@index([providerId, featured])
  @@map("portfolios")
}

// Portfolio Images
model PortfolioImage {
  id          String    @id @default(cuid())
  portfolioId String
  portfolio   Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)

  url         String
  thumbnail   String?
  order       Int       @default(0)
  caption     String?

  // AI Analysis (future)
  aiTags      String[]
  aiQualityScore Float?

  createdAt   DateTime  @default(now())

  @@index([portfolioId, order])
  @@map("portfolio_images")
}

// Before & After Photos
model BeforeAfterPhoto {
  id          String          @id @default(cuid())
  providerId  String
  provider    ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)

  beforeImage String
  afterImage  String
  serviceType String
  description String?         @db.Text
  verified    Boolean         @default(false)

  likes       Int             @default(0)
  viewCount   Int             @default(0)

  createdAt   DateTime        @default(now())

  @@index([providerId, verified])
  @@map("before_after_photos")
}

// ==================== Phase 4: Staff Management ====================

// Staff Member
model StaffMember {
  id          String          @id @default(cuid())
  providerId  String
  provider    ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)

  userId      String          @unique
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  role        StaffRole
  permissions Json?           // Custom permissions
  schedule    Json?           // Weekly schedule

  // Employment
  active      Boolean         @default(true)
  hireDate    DateTime
  terminationDate DateTime?

  // Commission
  commissionRate Float?        // Percentage
  salary      Float?

  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  appointments Appointment[]

  @@index([providerId, active])
  @@map("staff_members")
}

enum StaffRole {
  OWNER
  MANAGER
  STYLIST
  ESTHETICIAN
  MASSAGE_THERAPIST
  NAIL_TECHNICIAN
  RECEPTIONIST
}

// ==================== Phase 4: Inventory Management ====================

// Product
model Product {
  id          String          @id @default(cuid())
  providerId  String
  provider    ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)

  name        String
  description String?         @db.Text
  sku         String?
  barcode     String?

  // Inventory
  quantity    Int             @default(0)
  lowStockThreshold Int       @default(10)
  unit        String          @default("unit") // unit, oz, ml, etc.

  // Pricing
  costPrice   Float
  sellPrice   Float?

  // Category
  category    String
  brand       String?

  // Retail
  availableForSale Boolean    @default(false)

  active      Boolean         @default(true)

  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  transactions InventoryTransaction[]

  @@index([providerId, active])
  @@map("products")
}

// Inventory Transaction
model InventoryTransaction {
  id          String          @id @default(cuid())
  productId   String
  product     Product         @relation(fields: [productId], references: [id], onDelete: Cascade)

  type        TransactionType
  quantity    Int             // Positive for IN, negative for OUT

  // Cost tracking
  unitCost    Float?
  totalCost   Float?

  // Reference
  referenceType String?       // "purchase", "sale", "adjustment", "waste"
  referenceId String?         // Order ID, Appointment ID, etc.

  notes       String?
  performedBy String?         // userId

  createdAt   DateTime        @default(now())

  @@index([productId, createdAt])
  @@map("inventory_transactions")
}

enum TransactionType {
  PURCHASE      // Stock received
  SALE          // Sold to customer
  ADJUSTMENT    // Manual adjustment
  WASTE         // Expired/damaged
  SERVICE_USE   // Used in service
}

// ==================== Phase 4: Marketing Automation ====================

// Marketing Campaign
model Campaign {
  id          String          @id @default(cuid())
  providerId  String?
  provider    ProviderProfile? @relation(fields: [providerId], references: [id], onDelete: Cascade)
  createdBy   String
  creator     User            @relation(fields: [createdBy], references: [id])

  name        String
  type        CampaignType
  status      CampaignStatus  @default(DRAFT)

  // Targeting
  targetAudience Json          // Filters for recipients

  // Content
  subject     String?
  message     String          @db.Text
  templateId  String?
  template    EmailTemplate?  @relation(fields: [templateId], references: [id])

  // Scheduling
  scheduledFor DateTime?
  sentAt      DateTime?

  // Analytics
  recipientCount Int           @default(0)
  sentCount   Int             @default(0)
  openCount   Int             @default(0)
  clickCount  Int             @default(0)

  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@index([providerId, status])
  @@map("campaigns")
}

enum CampaignType {
  EMAIL
  SMS
  PUSH
  MULTI_CHANNEL
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  CANCELLED
}

// Email Template
model EmailTemplate {
  id          String   @id @default(cuid())
  name        String
  subject     String
  htmlContent String   @db.Text
  textContent String?  @db.Text

  // Variables
  variables   String[] // ["firstName", "appointmentDate", etc.]

  // Category
  category    TemplateCategory

  // Usage
  isDefault   Boolean  @default(false)
  active      Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  campaigns   Campaign[]

  @@map("email_templates")
}

enum TemplateCategory {
  APPOINTMENT_REMINDER
  APPOINTMENT_CONFIRMATION
  REVIEW_REQUEST
  PROMOTION
  BIRTHDAY
  WELCOME
  THANK_YOU
}

// ==================== Phase 5: Marketing & Promotions ====================

// Coupon/Discount Code
model Coupon {
  id          String       @id @default(cuid())
  providerId  String
  provider    ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)

  // Coupon Details
  code        String       @unique
  name        String
  description String?      @db.Text
  type        CouponType

  // Discount Value
  discountType DiscountType  // PERCENTAGE or FIXED
  discountValue Float        // 20 (for 20%) or 50 (for $50)
  maxDiscount  Float?        // Max discount amount for percentage coupons
  minPurchase  Float?        // Minimum purchase amount required

  // Validity
  startDate   DateTime
  endDate     DateTime?
  active      Boolean      @default(true)

  // Usage Limits
  usageLimit  Int?         // Max total uses (null = unlimited)
  usageCount  Int          @default(0)
  perUserLimit Int?        // Max uses per user

  // Applicability
  applicableServices String[] // Service IDs (empty = all services)
  newCustomersOnly Boolean  @default(false)

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Relations
  usages      CouponUsage[]

  @@index([providerId, active])
  @@index([code])
  @@map("coupons")
}

enum CouponType {
  PUBLIC          // Anyone can use
  PRIVATE         // Need to be shared directly
  REFERRAL        // From referral program
  BIRTHDAY        // Auto-sent on birthdays
}

enum DiscountType {
  PERCENTAGE
  FIXED
}

// Coupon Usage
model CouponUsage {
  id            String      @id @default(cuid())
  couponId      String
  coupon        Coupon      @relation(fields: [couponId], references: [id], onDelete: Cascade)

  customerId    String
  customer      User        @relation(fields: [customerId], references: [id])

  appointmentId String?     @unique

  discountAmount Float      // Actual discount applied
  usedAt        DateTime    @default(now())

  @@index([couponId, customerId])
  @@map("coupon_usages")
}

// Referral Program
model ReferralProgram {
  id            String          @id @default(cuid())
  providerId    String          @unique
  provider      ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)

  // Program Settings
  active        Boolean         @default(true)

  // Referrer Rewards (person who shares)
  referrerRewardType DiscountType
  referrerRewardValue Float      // e.g., 20 for 20% or $20
  referrerMaxReward Float?

  // Referee Rewards (new customer)
  refereeRewardType DiscountType
  refereeRewardValue Float
  refereeMaxReward Float?

  // Conditions
  minPurchaseAmount Float?      // Minimum first purchase to qualify
  referralExpireDays Int @default(90) // Days before referral link expires

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@map("referral_programs")
}

// Referral
model Referral {
  id            String      @id @default(cuid())

  // Who referred
  referrerId    String
  referrer      User        @relation("Referrer", fields: [referrerId], references: [id])

  // Who was referred
  refereeId     String
  referee       User        @relation("Referee", fields: [refereeId], references: [id])

  providerId    String
  provider      ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)

  // Referral Link
  referralCode  String      @unique

  // Status
  status        ReferralStatus @default(PENDING)

  // First appointment by referee
  firstAppointmentId String?
  completedAt   DateTime?    // When referee completed first appointment

  // Rewards
  referrerRewardAmount Float?
  refereeRewardAmount Float?
  rewardsIssued Boolean     @default(false)

  createdAt     DateTime    @default(now())
  expiresAt     DateTime?

  @@index([referrerId])
  @@index([refereeId])
  @@index([providerId])
  @@index([referralCode])
  @@map("referrals")
}

enum ReferralStatus {
  PENDING        // Link shared but not used yet
  REGISTERED     // Referee signed up
  COMPLETED      // Referee completed first appointment
  EXPIRED        // Link expired
  CANCELLED      // Cancelled for some reason
}

// Customer Wallet (for storing credits from referrals)
model CustomerWallet {
  id            String      @id @default(cuid())
  customerId    String      @unique
  customer      User        @relation(fields: [customerId], references: [id], onDelete: Cascade)

  balance       Float       @default(0)
  totalEarned   Float       @default(0)
  totalSpent    Float       @default(0)

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  transactions  WalletTransaction[]

  @@map("customer_wallets")
}

// Wallet Transaction
model WalletTransaction {
  id            String        @id @default(cuid())
  walletId      String
  wallet        CustomerWallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  type          TransactionKind
  amount        Float
  description   String

  referenceType String?       // "referral", "coupon", "refund"
  referenceId   String?

  balanceBefore Float
  balanceAfter  Float

  createdAt     DateTime      @default(now())

  @@index([walletId, createdAt])
  @@map("wallet_transactions")
}

enum TransactionKind {
  CREDIT        // Money added
  DEBIT         // Money spent
}
