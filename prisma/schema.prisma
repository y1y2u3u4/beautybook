// Prisma Schema for BeautyBook
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Model (synced with Clerk)
model User {
  id            String   @id @default(cuid())
  clerkId       String   @unique @map("clerk_id")
  email         String   @unique
  firstName     String?  @map("first_name")
  lastName      String?  @map("last_name")
  imageUrl      String?  @map("image_url")
  role          UserRole @default(CUSTOMER)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  customerProfile CustomerProfile?
  providerProfile ProviderProfile?
  appointments    Appointment[]
  reviews         Review[]
  favorites       Favorite[]
  notifications   Notification[]
  notificationPreference NotificationPreference?
  staffMember     StaffMember?
  campaigns       Campaign[]

  @@map("users")
}

enum UserRole {
  CUSTOMER
  PROVIDER
  ADMIN
}

// Customer Profile
model CustomerProfile {
  id            String   @id @default(cuid())
  userId        String   @unique @map("user_id")
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  phone         String?
  dateOfBirth   DateTime? @map("date_of_birth")
  address       String?
  city          String?
  state         String?
  zipCode       String?  @map("zip_code")

  // Medical History
  medicalHistory Json?   @map("medical_history")
  allergies      String[]

  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("customer_profiles")
}

// Provider Profile
model ProviderProfile {
  id              String   @id @default(cuid())
  userId          String   @unique @map("user_id")
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Basic Info
  businessName    String   @map("business_name")
  title           String
  bio             String   @db.Text
  phone           String
  verified        Boolean  @default(false)

  // Location
  address         String
  city            String
  state           String
  zipCode         String   @map("zip_code")
  latitude        Float?
  longitude       Float?

  // Professional Info
  experience      Int      @default(0) // years
  languages       String[]
  specialties     String[]

  // Pricing
  priceMin        Float    @map("price_min")
  priceMax        Float    @map("price_max")

  // Insurance
  insuranceAccepted String[] @map("insurance_accepted")

  // Ratings
  averageRating   Float    @default(0) @map("average_rating")
  reviewCount     Int      @default(0) @map("review_count")

  // Business Hours
  businessHours   Json?    @map("business_hours")

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  education       Education[]
  certifications  Certification[]
  services        Service[]
  appointments    Appointment[]
  reviews         Review[]
  availability    Availability[]
  portfolios      Portfolio[]
  beforeAfterPhotos BeforeAfterPhoto[]
  cancellationRules CancellationRule[]
  staffMembers    StaffMember[]
  products        Product[]
  campaigns       Campaign[]
  calendarSync    CalendarSync?

  @@map("provider_profiles")
}

// Education
model Education {
  id           String          @id @default(cuid())
  providerId   String          @map("provider_id")
  provider     ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)
  degree       String
  institution  String
  year         Int
  createdAt    DateTime        @default(now()) @map("created_at")

  @@map("education")
}

// Certification
model Certification {
  id           String          @id @default(cuid())
  providerId   String          @map("provider_id")
  provider     ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)
  name         String
  issuer       String
  year         Int
  expiryDate   DateTime?       @map("expiry_date")
  createdAt    DateTime        @default(now()) @map("created_at")

  @@map("certifications")
}

// Service
model Service {
  id          String          @id @default(cuid())
  providerId  String          @map("provider_id")
  provider    ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)
  name        String
  description String          @db.Text
  duration    Int             // minutes
  price       Float
  category    String
  active      Boolean         @default(true)
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  // Relations
  appointments Appointment[]

  @@map("services")
}

// Appointment
model Appointment {
  id          String            @id @default(cuid())

  // Relations
  customerId  String            @map("customer_id")
  customer    User              @relation(fields: [customerId], references: [id])
  providerId  String            @map("provider_id")
  provider    ProviderProfile   @relation(fields: [providerId], references: [id])
  serviceId   String            @map("service_id")
  service     Service           @relation(fields: [serviceId], references: [id])

  // Appointment Details
  date        DateTime
  startTime   String            @map("start_time")
  endTime     String            @map("end_time")
  status      AppointmentStatus @default(SCHEDULED)
  notes       String?           @db.Text

  // Payment
  amount      Float
  paymentStatus PaymentStatus   @default(PENDING) @map("payment_status")
  paymentId   String?           @map("payment_id")

  // Cancellation Policy & Deposit
  cancellationPolicy  CancellationPolicy @default(STANDARD) @map("cancellation_policy")
  depositRequired     Boolean            @default(false) @map("deposit_required")
  depositAmount       Float?             @map("deposit_amount")
  depositPaid         Boolean            @default(false) @map("deposit_paid")
  depositPaymentId    String?            @map("deposit_payment_id")

  // Cancellation Details
  cancelledAt         DateTime?          @map("cancelled_at")
  cancelledBy         String?            @map("cancelled_by") // userId
  cancellationReason  String?            @map("cancellation_reason")
  cancellationFee     Float?             @map("cancellation_fee")
  cancellationFeePaid Boolean            @default(false) @map("cancellation_fee_paid")

  // Calendar Integration
  googleEventId String?                  @map("google_event_id")

  // Staff Assignment
  staffMemberId String?                  @map("staff_member_id")
  staffMember   StaffMember? @relation(fields: [staffMemberId], references: [id])

  // Timestamps
  createdAt   DateTime          @default(now()) @map("created_at")
  updatedAt   DateTime          @updatedAt @map("updated_at")

  // Relations
  notifications Notification[]

  @@map("appointments")
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum PaymentStatus {
  PENDING
  PAID
  REFUNDED
  FAILED
}

// Review
model Review {
  id          String          @id @default(cuid())
  customerId  String          @map("customer_id")
  customer    User            @relation(fields: [customerId], references: [id])
  providerId  String          @map("provider_id")
  provider    ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)

  rating      Int             // 1-5
  comment     String          @db.Text
  verified    Boolean         @default(false)
  helpful     Int             @default(0)

  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  @@map("reviews")
}

// Favorite (Save providers)
model Favorite {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  providerId  String   @map("provider_id")
  createdAt   DateTime @default(now()) @map("created_at")

  @@unique([userId, providerId])
  @@map("favorites")
}

// Availability (Provider's available time slots)
model Availability {
  id          String          @id @default(cuid())
  providerId  String          @map("provider_id")
  provider    ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)

  dayOfWeek   Int             @map("day_of_week") // 0-6 (Sunday-Saturday)
  startTime   String          @map("start_time")
  endTime     String          @map("end_time")
  active      Boolean         @default(true)

  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  @@map("availability")
}

// ==================== Calendar Sync ====================

// Calendar Sync (Google Calendar Integration)
model CalendarSync {
  id            String          @id @default(cuid())
  providerId    String          @unique @map("provider_id")
  provider      ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)

  // Provider type
  provider_type String          @default("google") // google, outlook, etc.

  // OAuth tokens
  accessToken   String          @db.Text @map("access_token")
  refreshToken  String          @db.Text @map("refresh_token")
  expiresAt     DateTime?       @map("expires_at")

  // Sync settings
  enabled       Boolean         @default(true)
  autoSync      Boolean         @default(true) @map("auto_sync")
  syncDirection String          @default("both") @map("sync_direction") // import, export, both

  // Calendar info
  calendarId    String?         @map("calendar_id")

  // Timestamps
  lastSyncedAt  DateTime?       @map("last_synced_at")
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")

  @@map("calendar_sync")
}

// ==================== Phase 1: Notification System ====================

// Notification Preferences
model NotificationPreference {
  id           String   @id @default(cuid())
  userId       String   @unique @map("user_id")
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Channel Settings
  emailEnabled Boolean  @default(true) @map("email_enabled")
  smsEnabled   Boolean  @default(true) @map("sms_enabled")
  pushEnabled  Boolean  @default(true) @map("push_enabled")

  // Reminder Timing
  reminderBefore24h Boolean @default(true) @map("reminder_before_24h")
  reminderBefore2h  Boolean @default(true) @map("reminder_before_2h")
  reminderBefore30m Boolean @default(false) @map("reminder_before_30m")

  // Marketing
  marketingEnabled  Boolean @default(false) @map("marketing_enabled")
  birthdayReminders Boolean @default(true) @map("birthday_reminders")

  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("notification_preferences")
}

// Notification
model Notification {
  id            String             @id @default(cuid())
  userId        String             @map("user_id")
  user          User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  appointmentId String?            @map("appointment_id")
  appointment   Appointment?       @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  type          NotificationType
  channel       NotificationChannel
  status        NotificationStatus @default(PENDING)

  // Content
  subject       String?
  message       String            @db.Text
  data          Json?             // Additional data

  // Scheduling
  scheduledFor  DateTime          @map("scheduled_for")
  sentAt        DateTime?         @map("sent_at")

  // Delivery tracking
  deliveryId    String?           @map("delivery_id") // Twilio/SendGrid ID
  error         String?

  createdAt     DateTime          @default(now()) @map("created_at")

  @@index([userId, status])
  @@index([scheduledFor])
  @@map("notifications")
}

enum NotificationType {
  APPOINTMENT_REMINDER
  APPOINTMENT_CONFIRMED
  APPOINTMENT_CANCELLED
  APPOINTMENT_RESCHEDULED
  REVIEW_REQUEST
  PROMOTION
  BIRTHDAY
  PAYMENT_RECEIVED
  DEPOSIT_REQUIRED
}

enum NotificationChannel {
  EMAIL
  SMS
  PUSH
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
  CANCELLED
}

// ==================== Phase 1: Cancellation Policy ====================

enum CancellationPolicy {
  FLEXIBLE   // Cancel anytime
  MODERATE   // Cancel 12h before
  STANDARD   // Cancel 24h before
  STRICT     // Cancel 48h before
}

// Cancellation Rules
model CancellationRule {
  id              String          @id @default(cuid())
  providerId      String          @map("provider_id")
  provider        ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)

  policy          CancellationPolicy @default(STANDARD)
  hoursBeforeAppt Int             @map("hours_before_appt") // Hours before appointment
  feePercentage   Float           @map("fee_percentage") // 0-100
  feeFixed        Float?          @map("fee_fixed") // Optional fixed fee

  applyToNewClients Boolean       @default(true) @map("apply_to_new_clients")
  active          Boolean         @default(true)

  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  @@map("cancellation_rules")
}

// ==================== Phase 1: Portfolio & Photos ====================

// Portfolio
model Portfolio {
  id          String          @id @default(cuid())
  providerId  String          @map("provider_id")
  provider    ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)

  title       String
  description String?         @db.Text
  category    String          // "Hair", "Makeup", "Nails", etc.
  featured    Boolean         @default(false)
  viewCount   Int             @default(0) @map("view_count")

  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  images      PortfolioImage[]

  @@index([providerId, featured])
  @@map("portfolios")
}

// Portfolio Images
model PortfolioImage {
  id          String    @id @default(cuid())
  portfolioId String    @map("portfolio_id")
  portfolio   Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)

  url         String
  thumbnail   String?
  order       Int       @default(0)
  caption     String?

  // AI Analysis (future)
  aiTags      String[]  @map("ai_tags")
  aiQualityScore Float? @map("ai_quality_score")

  createdAt   DateTime  @default(now()) @map("created_at")

  @@index([portfolioId, order])
  @@map("portfolio_images")
}

// Before & After Photos
model BeforeAfterPhoto {
  id          String          @id @default(cuid())
  providerId  String          @map("provider_id")
  provider    ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)

  beforeImage String          @map("before_image")
  afterImage  String          @map("after_image")
  serviceType String          @map("service_type")
  description String?         @db.Text
  verified    Boolean         @default(false)

  likes       Int             @default(0)
  viewCount   Int             @default(0) @map("view_count")

  createdAt   DateTime        @default(now()) @map("created_at")

  @@index([providerId, verified])
  @@map("before_after_photos")
}

// ==================== Phase 4: Staff Management ====================

// Staff Member
model StaffMember {
  id          String          @id @default(cuid())
  providerId  String          @map("provider_id")
  provider    ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)

  userId      String          @unique @map("user_id")
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  role        StaffRole
  permissions Json?           // Custom permissions
  schedule    Json?           // Weekly schedule

  // Employment
  active      Boolean         @default(true)
  hireDate    DateTime        @map("hire_date")
  terminationDate DateTime?   @map("termination_date")

  // Commission
  commissionRate Float?       @map("commission_rate") // Percentage
  salary      Float?

  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  appointments Appointment[]

  @@index([providerId, active])
  @@map("staff_members")
}

enum StaffRole {
  OWNER
  MANAGER
  STYLIST
  ESTHETICIAN
  MASSAGE_THERAPIST
  NAIL_TECHNICIAN
  RECEPTIONIST
}

// ==================== Phase 4: Inventory Management ====================

// Product
model Product {
  id          String          @id @default(cuid())
  providerId  String          @map("provider_id")
  provider    ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)

  name        String
  description String?         @db.Text
  sku         String?
  barcode     String?

  // Inventory
  quantity    Int             @default(0)
  lowStockThreshold Int       @default(10) @map("low_stock_threshold")
  unit        String          @default("unit") // unit, oz, ml, etc.

  // Pricing
  costPrice   Float           @map("cost_price")
  sellPrice   Float?          @map("sell_price")

  // Category
  category    String
  brand       String?

  // Retail
  availableForSale Boolean    @default(false) @map("available_for_sale")

  active      Boolean         @default(true)

  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  transactions InventoryTransaction[]

  @@index([providerId, active])
  @@map("products")
}

// Inventory Transaction
model InventoryTransaction {
  id          String          @id @default(cuid())
  productId   String          @map("product_id")
  product     Product         @relation(fields: [productId], references: [id], onDelete: Cascade)

  type        TransactionType
  quantity    Int             // Positive for IN, negative for OUT

  // Cost tracking
  unitCost    Float?          @map("unit_cost")
  totalCost   Float?          @map("total_cost")

  // Reference
  referenceType String?       @map("reference_type") // "purchase", "sale", "adjustment", "waste"
  referenceId String?         @map("reference_id") // Order ID, Appointment ID, etc.

  notes       String?
  performedBy String?         @map("performed_by") // userId

  createdAt   DateTime        @default(now()) @map("created_at")

  @@index([productId, createdAt])
  @@map("inventory_transactions")
}

enum TransactionType {
  PURCHASE      // Stock received
  SALE          // Sold to customer
  ADJUSTMENT    // Manual adjustment
  WASTE         // Expired/damaged
  SERVICE_USE   // Used in service
}

// ==================== Phase 4: Marketing Automation ====================

// Marketing Campaign
model Campaign {
  id          String          @id @default(cuid())
  providerId  String?         @map("provider_id")
  provider    ProviderProfile? @relation(fields: [providerId], references: [id], onDelete: Cascade)
  createdBy   String          @map("created_by")
  creator     User            @relation(fields: [createdBy], references: [id])

  name        String
  type        CampaignType
  status      CampaignStatus  @default(DRAFT)

  // Targeting
  targetAudience Json         @map("target_audience") // Filters for recipients

  // Content
  subject     String?
  message     String          @db.Text
  templateId  String?         @map("template_id")
  template    EmailTemplate?  @relation(fields: [templateId], references: [id])

  // Scheduling
  scheduledFor DateTime?      @map("scheduled_for")
  sentAt      DateTime?       @map("sent_at")

  // Analytics
  recipientCount Int          @default(0) @map("recipient_count")
  sentCount   Int             @default(0) @map("sent_count")
  openCount   Int             @default(0) @map("open_count")
  clickCount  Int             @default(0) @map("click_count")

  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  @@index([providerId, status])
  @@map("campaigns")
}

enum CampaignType {
  EMAIL
  SMS
  PUSH
  MULTI_CHANNEL
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  CANCELLED
}

// Email Template
model EmailTemplate {
  id          String   @id @default(cuid())
  name        String
  subject     String
  htmlContent String   @db.Text @map("html_content")
  textContent String?  @db.Text @map("text_content")

  // Variables
  variables   String[] // ["firstName", "appointmentDate", etc.]

  // Category
  category    TemplateCategory

  // Usage
  isDefault   Boolean  @default(false) @map("is_default")
  active      Boolean  @default(true)

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  campaigns   Campaign[]

  @@map("email_templates")
}

enum TemplateCategory {
  APPOINTMENT_REMINDER
  APPOINTMENT_CONFIRMATION
  REVIEW_REQUEST
  PROMOTION
  BIRTHDAY
  WELCOME
  THANK_YOU
}
